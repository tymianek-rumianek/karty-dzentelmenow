<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSP pozwalające na Firebase (działa na GitHub Pages / Firebase Hosting) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://www.gstatic.com https://www.gstatic.com/firebasejs/ 'unsafe-inline';
                 connect-src 'self' https://*.googleapis.com https://*.gstatic.com https://*.firebaseio.com https://*.firebaseinstallations.googleapis.com data: blob:;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline';
                 font-src 'self' data:;" />
  <title>Karty Dżentelmenów — Online</title>

  <style>
    /* ====== Reset & bazowe ====== */
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:#000;font-family:Inter,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
    header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;border-bottom:1px solid #000}
    .title{font-weight:800;font-size:18px}
    .hidden{display:none}
    .small{font-size:12px}

    /* ====== Pasek graczy (wyśrodkowany, prostokącik sędziego) ====== */
    .players-bar{
      position:sticky;top:8px;z-index:10;
      display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;padding:10px 0 16px;
    }
    .player{
      position:relative;
      min-width:100px;height:28px;background:#fff;color:#000;
      border:1px solid #000;border-radius:4px;display:flex;align-items:center;justify-content:center;
      padding:0 10px;font-size:13px;line-height:1
    }
    /* czarny prostokąt POD sędzią */
    .player.active::after{
      content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-10px;
      width:44px; height:8px; background:#000; border-radius:2px;
    }

    /* ====== Plansza: lewy panel / czarna karta / ręka ====== */
    .board{
      display:grid;
      grid-template-columns: 260px min(34vw,560px) min(36vw,620px);
      gap:48px;
      align-items:start;
      justify-content:center; /* CAŁA siatka wyśrodkowana */
      min-height:72vh;
    }

    /* Lewy panel – przyciski i info pokoju */
    .ctrl{
      border:1px solid #000;border-radius:6px;padding:14px;background:#fff;position:sticky;top:56px
    }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:6px}
    input{border:1px solid #000;border-radius:6px;padding:8px 10px}
    button{border:1px solid #000;border-radius:6px;padding:10px 14px;font-weight:700;background:#000;color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:#000}
    .badge{display:inline-block;border:1px solid #000;border-radius:999px;padding:4px 10px}

    /* Czarna karta (prompt) – centrum, z obrazkiem lub fallbackiem */
    .prompt-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
    .prompt{
      width:min(34vw,560px);aspect-ratio:2.5/3.5;background:#000;color:#fff;
      border:1px solid #000;border-radius:8px;display:flex;align-items:center;justify-content:center;
      text-align:center;padding:18px;font-size:20px;transition:transform .22s ease,opacity .22s ease;overflow:hidden
    }
    .prompt img{display:block;width:100%;height:100%;object-fit:cover}
    .prompt .fallback{padding:18px}

    /* Panel ręki gracza – prawa kolumna */
    .hand{border:1px solid #000;border-radius:8px;padding:14px;background:#fff}
    .hand-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width:1200px){ .hand-grid{grid-template-columns: repeat(3, 1fr);} }
    .card-btn{
      border:1px solid #000;border-radius:8px;background:#fff;cursor:pointer;padding:0;
      width:100%;aspect-ratio:2.5/3.5;display:flex;align-items:center;justify-content:center;overflow:hidden;
      transition:transform .15s ease
    }
    .card-btn:hover{transform:translateY(-2px)}
    .card-btn img{width:100%;height:100%;object-fit:cover;display:block}
    .card-btn .fallback{padding:10px;font-size:12px;text-align:center}

    /* Podgląd karty na hover */
    .preview{position:fixed;inset:0;pointer-events:none;z-index:30;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.98);transition:opacity .18s ease,transform .18s ease}
    .preview.visible{opacity:1;transform:scale(1)}
    .preview-card{
      width:min(50vw,640px);aspect-ratio:2.5/3.5;border:1px solid #000;border-radius:8px;background:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.20);overflow:hidden;display:flex;align-items:center;justify-content:center
    }
    .preview-card img{width:100%;height:100%;object-fit:cover;display:block}
    .preview-card .fallback{padding:16px;font-size:18px;text-align:center;color:#000}

    /* Efekt globalny podczas podglądu */
    body.previewing .prompt{transform:translateX(-10vw) scale(.88)}
    body.previewing .players-bar{gap:10px}

    /* Sekcja start/join */
    .card{border:1px solid #000;border-radius:8px;padding:14px;background:#fff}
    .warn{border:1px solid #000;border-radius:6px;padding:8px;background:#fff1f1;color:#000}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Karty Dżentelmenów — Online</div>
    <div class="small" id="alert" class="warn hidden"></div>
  </header>

  <!-- Ekran startowy (bez zmian) -->
  <section id="screen-home" class="card">
    <div class="row">
      <button id="go-create">Stwórz lobby</button>
      <button id="go-join" class="ghost">Dołącz do gry</button>
    </div>
  </section>

  <!-- Tworzenie lobby (bez zmian) -->
  <section id="screen-create" class="card hidden">
    <div class="col" style="max-width:480px">
      <label class="small">Twój nick</label>
      <input id="create-nick" placeholder="np. Tymianek" />
      <div class="row">
        <button id="btn-create">Utwórz lobby</button>
        <button class="ghost" id="back1">Wróć</button>
      </div>
    </div>
  </section>

  <!-- Dołączanie (bez zmian) -->
  <section id="screen-join" class="card hidden">
    <div class="col" style="max-width:480px">
      <label class="small">Kod pokoju</label>
      <input id="join-code" placeholder="np. R4F7" />
      <label class="small">Twój nick</label>
      <input id="join-nick" placeholder="np. Gość" />
      <div class="row">
        <button id="btn-join">Dołącz</button>
        <button class="ghost" id="back2">Wróć</button>
      </div>
    </div>
  </section>

  <!-- Rozgrywka -->
  <section id="screen-room" class="hidden">
    <!-- Pasek graczy -->
    <div id="players" class="players-bar"></div>

    <div class="board">
      <!-- Lewy panel: przyciski/info -->
      <aside class="ctrl">
        <div class="col">
          <div class="small">Pokój</div>
          <div class="row">
            <div class="badge">Kod: <b id="room-code">—</b></div>
            <button id="copy-code" class="ghost">Kopiuj</button>
          </div>
          <div class="small" style="margin-top:8px">Sterowanie</div>
          <div class="row">
            <button id="btn-start">Start rundy</button>
            <button id="btn-leave" class="ghost">Wyjdź</button>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="badge">Runda: <b id="round-no">0</b></div>
            <div class="badge">Sędzia: <b id="czar-name">—</b></div>
          </div>
        </div>
      </aside>

      <!-- Środek: czarna karta (obrazek lub fallback tekstowy) -->
      <main class="prompt-wrap">
        <div id="prompt" class="prompt"><div class="fallback">—</div></div>
      </main>

      <!-- Prawa: ręka gracza (karty jako PNG lub tekst) -->
      <aside class="hand">
        <div class="small" style="margin-bottom:8px">Twoja ręka</div>
        <div id="hand" class="hand-grid"></div>
      </aside>
    </div>

    <!-- Miejsce na zagrane odpowiedzi -->
    <div id="answers" class="card hidden"></div>
  </section>
</div>

<!-- Podgląd dużej karty -->
<div id="preview" class="preview hidden" aria-hidden="true">
  <div id="previewCard" class="preview-card"></div>
</div>

<script type="module">
  /* ====== UI helpers ====== */
  const $ = s => document.querySelector(s);
  const screens = {
    home: $('#screen-home'),
    create: $('#screen-create'),
    join: $('#screen-join'),
    room: $('#screen-room')
  };
  const playersEl = $('#players');
  const promptEl  = $('#prompt');
  const answersEl = $('#answers');
  const handEl    = $('#hand');
  const roundEl   = $('#round-no');
  const czarNameEl= $('#czar-name');
  const roomCodeEl= $('#room-code');
  const alertBox  = $('#alert');

  function show(name){
    Object.values(screens).forEach(x=>x.classList.add('hidden'));
    screens[name].classList.remove('hidden');
  }
  function warn(msg){ alertBox.textContent = msg; alertBox.classList.remove('hidden'); console.error(msg); }
  function nowarn(){ alertBox.classList.add('hidden'); alertBox.textContent=''; }

  $('#go-create').onclick = ()=> show('create');
  $('#go-join').onclick   = ()=> show('join');
  $('#back1').onclick     = ()=> show('home');
  $('#back2').onclick     = ()=> show('home');

  let firebaseReady=false, me={id:null,name:null}, room=null;
  let unsubRoom=null, unsubPlayers=null, unsubSubs=null, unsubHand=null;

  /* ====== Firebase (CDN) ====== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6emXNbCXSwx2xCAaUnQw9YR29Zzg1JzU",
    authDomain: "karty-dzentelmenow.firebaseapp.com",
    projectId: "karty-dzentelmenow",
    storageBucket: "karty-dzentelmenow.appspot.com",
    messagingSenderId: "1024966784216",
    appId: "1:1024966784216:web:9eecee00ee849f079313ad"
  };

  let app, auth, db;
  try{
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    await signInAnonymously(auth);
    db = getFirestore(app);
    firebaseReady = true; nowarn();
  }catch(e){
    console.error("AUTH ERROR:", e);
    warn('Firebase nie działa: ' + (e?.code || e?.message || e));
  }

  /* ====== Dane demo ====== */
  const DEFAULT_QUESTIONS = [
    "_________ to najlepszy sposób na rozpoczęcie dnia.",
    "W piekle czeka na mnie kara za _________.",
    "Kiedy byłem dzieckiem, najbardziej bałem się _________.",
    "Mój sekret na udaną randkę: _________.",
  ];
  const DEFAULT_ANSWERS = [
    "pół kilo żelatyny","księdza na hulajnodze elektrycznej","martwego gołębia w plecaku","mój plan na życie","znudzonego nauczyciela WF-u","sandacz po litewsku","szósty kubek kawy","kredyt na 30 lat",
    // przykładowy obrazek: możesz podać pełny URL PNG i karta wyrenderuje się jako <img>
    "https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder_view_vector.svg"
  ];

  /* ====== Helpers ====== */
  function makeCode(len=4){ const a='ABCDEFGHJKMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
  function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  const looksLikeImage = (t)=> typeof t==='string' && /\.(png|jpg|jpeg|webp|gif)$/i.test(t) || /^https?:\/\/.+\.(png|jpg|jpeg|webp|gif)(\?.*)?$/i.test(t);

  /* ====== UI -> akcje ====== */
  $('#btn-create').onclick= ()=> firebaseReady? createLobby(): warn('Backend niegotowy. Odśwież.');
  $('#btn-join').onclick  = ()=> firebaseReady? joinLobby()  : warn('Backend niegotowy.');
  $('#btn-start').onclick = ()=> firebaseReady? startRound() : warn('Backend niegotowy.');
  $('#btn-leave').onclick = ()=> firebaseReady? leaveRoom()  : show('home');
  $('#copy-code').onclick = ()=> copyCode();

  show('home');

  /* ====== Flow gry (Firestore) ====== */
  async function createLobby(){
    try{
      const nick = $('#create-nick').value.trim() || 'Gracz';
      const code = makeCode();
      const uid  = auth.currentUser.uid; me = {id: uid, name: nick};

      const roomRef = doc(db,'rooms',code);
      await setDoc(roomRef,{
        code, createdAt: serverTimestamp(), stage:'lobby', round:0,
        czarId:null, czarIdx:0, prompt:'', promptImg:'', winner:null,
        deckQ: shuffle([...DEFAULT_QUESTIONS]),
        deckA: shuffle([...DEFAULT_ANSWERS]),
        discardQ:[], discardA:[],
        hostId: uid
      });
      await setDoc(doc(db,'rooms',code,'players',uid),{ name:nick, score:0, joinedAt:serverTimestamp(), isOnline:true });
      await setDoc(doc(db,'rooms',code,'hands',uid),{ cards:[] });

      await enterRoom(code);
    }catch(e){ warn('Błąd tworzenia pokoju: '+(e?.message||e)); }
  }

  async function joinLobby(){
    try{
      const code = ($('#join-code').value||'').trim().toUpperCase();
      const nick = ($('#join-nick').value||'').trim() || 'Gość';
      if(!code) return warn('Podaj kod.');
      const roomRef = doc(db,'rooms',code);
      if(!(await getDoc(roomRef)).exists()) return warn('Nie ma takiego pokoju.');

      const uid = auth.currentUser.uid; me = {id: uid, name: nick};
      await setDoc(doc(db,'rooms',code,'players',uid),{ name:nick, score:0, joinedAt:serverTimestamp(), isOnline:true });
      const handRef = doc(db,'rooms',code,'hands',uid);
      if(!(await getDoc(handRef)).exists()) await setDoc(handRef,{cards:[]});

      await enterRoom(code);
    }catch(e){ warn('Błąd dołączania: '+(e?.message||e)); }
  }

  async function enterRoom(code){ subscribeRoom(code); show('room'); }

  function subscribeRoom(code){
    roomCodeEl.textContent = code;
    unsubRoom?.(); unsubPlayers?.(); unsubSubs?.(); unsubHand?.();

    const roomRef = doc(db,'rooms',code);
    unsubRoom = onSnapshot(roomRef,(snap)=>{ room = snap.data(); renderRoom(); });

    const playersCol = collection(db,'rooms',code,'players');
    unsubPlayers = onSnapshot(playersCol,(snap)=>{
      room.players = []; snap.forEach(d=>room.players.push({id:d.id,...d.data()}));
      renderPlayers();
    });

    const subsCol = collection(db,'rooms',code,'submissions');
    unsubSubs = onSnapshot(subsCol,(snap)=>{
      room.submissions = []; snap.forEach(d=>room.submissions.push({id:d.id,...d.data()}));
      renderSubmissions();
    });

    const handRef = doc(db,'rooms',code,'hands',(auth.currentUser||{}).uid||'');
    unsubHand = onSnapshot(handRef,(snap)=>{ room.myHand = snap.data()?.cards || []; renderHand(); });
  }

  async function leaveRoom(){
    try{
      if(!room) { show('home'); return; }
      const code = room.code; const uid = (auth.currentUser||{}).uid;
      await Promise.all([
        deleteDoc(doc(db,'rooms',code,'players',uid)),
        deleteDoc(doc(db,'rooms',code,'hands',uid)),
        deleteDoc(doc(db,'rooms',code,'submissions',uid)).catch(()=>{})
      ]);
      unsubRoom?.(); unsubPlayers?.(); unsubSubs?.(); unsubHand?.();
      room=null; show('home');
    }catch(e){ warn('Błąd opuszczania pokoju: '+(e?.message||e)); }
  }

  async function startRound(){
    try{
      if(!room) return;
      if(((auth.currentUser||{}).uid)!==room.hostId) return warn('Tylko host może rozpocząć rundę.');
      const code = room.code;

      const playersSnap = await getDocs(collection(db,'rooms',code,'players'));
      const players = []; playersSnap.forEach(d=>players.push({id:d.id,...d.data()}));
      if(players.length<3) return warn('Potrzeba min. 3 graczy.');

      const czarIdx = room.czarIdx||0; const czar = players[czarIdx % players.length];

      let deckQ = [...(room.deckQ||[])]; let discardQ = [...(room.discardQ||[])];
      if(!deckQ.length){ deckQ = shuffle(discardQ); discardQ = []; }
      if(!deckQ.length) return warn('Brak kart pytań.');
      const prompt = deckQ.shift();

      let deckA = [...(room.deckA||[])]; let discardA = [...(room.discardA||[])];
      if(deckA.length < players.length*3 && discardA.length) { deckA = deckA.concat(shuffle(discardA)); discardA = []; }

      const batch = writeBatch(db);

      for(const p of players){
        const hRef = doc(db,'rooms',code,'hands',p.id);
        const hSnap = await getDoc(hRef);
        const cards = hSnap.exists()? (hSnap.data().cards||[]) : [];
        const need = Math.max(0, 7 - cards.length);
        for(let i=0;i<need;i++){ if(!deckA.length) break; cards.push(deckA.shift()); }
        batch.set(hRef,{cards});
      }

      const subsSnap = await getDocs(collection(db,'rooms',code,'submissions'));
      subsSnap.forEach(s=> batch.delete(doc(db,'rooms',code,'submissions',s.id)));

      batch.update(doc(db,'rooms',code),{
        stage:'playing', round:(room.round||0)+1,
        czarId: czar.id, czarIdx: (czarIdx+1)%players.length,
        prompt, promptImg:'', deckQ, discardQ, deckA, discardA, winner:null
      });

      await batch.commit();
    }catch(e){ warn('Błąd startu rundy: '+(e?.message||e)); }
  }

  async function playCard(index){
    try{
      if(!room || room.stage!=='playing') return;
      if(room.czarId===(auth.currentUser||{}).uid) return warn('Sędzia nie zagrywa.');
      const code = room.code;
      const hRef = doc(db,'rooms',code,'hands',(auth.currentUser||{}).uid||'');
      const hSnap = await getDoc(hRef);
      const cards = hSnap.data()?.cards||[];
      const card = cards[index]; if(!card) return;

      await setDoc(doc(db,'rooms',code,'submissions',(auth.currentUser||{}).uid||''),{
        uid:(auth.currentUser||{}).uid, name:me.name, text:card, at:serverTimestamp()
      });

      cards.splice(index,1); await updateDoc(hRef,{cards});
    }catch(e){ warn('Błąd zagrania karty: '+(e?.message||e)); }
  }

  async function chooseWinner(uid){
    try{
      if(room.czarId!==(auth.currentUser||{}).uid) return;
      const code = room.code;
      const subRef = doc(db,'rooms',code,'submissions',uid);
      const subSnap = await getDoc(subRef); if(!subSnap.exists()) return;
      const winText = subSnap.data().text;

      const pRef = doc(db,'rooms',code,'players',uid);
      const pSnap = await getDoc(pRef); const score = (pSnap.data()?.score||0)+1;

      const batch = writeBatch(db);
      batch.update(doc(db,'rooms',code),{ winner:{uid, text:winText} });
      batch.update(pRef,{score}); await batch.commit();
    }catch(e){ warn('Błąd wyboru zwycięzcy: '+(e?.message||e)); }
  }

  function copyCode(){ if(!room?.code) return; navigator.clipboard.writeText(room.code).catch(()=>{}); }

  /* ====== Render ====== */
  function renderRoom(){
    if(!room) return;
    roundEl.textContent = room.round||0;

    // Czarna karta: jeżeli masz PNG/URL w room.promptImg — pokaż obrazek, inaczej tekst.
    const hasImg = room.promptImg && typeof room.promptImg==='string';
    promptEl.innerHTML = hasImg
      ? `<img alt="czarna karta" src="${room.promptImg}">`
      : `<div class="fallback">${esc(room.prompt || '—')}</div>`;

    const czar = (room.players||[]).find(p=>p.id===room.czarId);
    czarNameEl.textContent = czar? czar.name : '—';
  }

  function renderPlayers(){
    const players = room?.players || [];
    const czarId = room?.czarId || null;
    playersEl.innerHTML = players.map(p =>
      `<div class="player ${p.id===czarId?'active':''}">${esc(p.name)}</div>`
    ).join('');
  }

  function renderSubmissions(){
    const subs = room?.submissions || [];
    if(!subs.length){ answersEl.classList.add('hidden'); answersEl.innerHTML=''; return; }
    answersEl.classList.remove('hidden');
    answersEl.innerHTML = `<div class="small" style="margin-bottom:8px">Zagrania</div>` +
      subs.map(s=>{
        const isImg = looksLikeImage(s.text);
        const inner = isImg ? `<img alt="" src="${s.text}">` : `<div class="fallback">${esc(s.text)}</div>`;
        return `<button class="card-btn ${room?.winner?.uid===s.uid?'selected':''}" data-uid="${s.uid}">${inner}</button>`;
      }).join('');
    if(room?.czarId===(auth.currentUser||{}).uid){
      answersEl.querySelectorAll('.card-btn').forEach(el => el.onclick = ()=> chooseWinner(el.getAttribute('data-uid')));
    }
  }

  // Ręka gracza: obsługa PNG albo tekstu
  function renderHand(){
    const hand = room?.myHand || [];
    handEl.innerHTML = hand.map((t,i)=>{
      const isImg = looksLikeImage(t);
      const inner = isImg ? `<img alt="" src="${t}">` : `<div class="fallback">${esc(t)}</div>`;
      return `<button class="card-btn" data-i="${i}">${inner}</button>`;
    }).join('');

    const preview = $('#preview');
    const previewCard = $('#previewCard');

    handEl.querySelectorAll('.card-btn').forEach(el=>{
      const i = parseInt(el.getAttribute('data-i'));
      el.onclick = ()=> playCard(i);
      el.addEventListener('mouseenter', ()=>{
        const t = hand[i];
        const isImg = looksLikeImage(t);
        previewCard.innerHTML = isImg
          ? `<img alt="" src="${t}">`
          : `<div class="fallback">${esc(t)}</div>`;
        document.body.classList.add('previewing');
        preview.classList.remove('hidden');
        requestAnimationFrame(()=> preview.classList.add('visible'));
      });
      el.addEventListener('mouseleave', ()=>{
        document.body.classList.remove('previewing');
        preview.classList.remove('visible');
        setTimeout(()=> preview.classList.add('hidden'),180);
      });
    });
  }

  Object.defineProperty(window,'firebaseAuthUid',{get(){return (auth&&auth.currentUser)?auth.currentUser.uid:null;}});

  /* ====== Szybki podgląd – wymuś ekran gry z układem (do dev) ======
     Odkomentuj dwie linie poniżej, jeśli chcesz zobaczyć układ bez łączenia.
  */
  // show('room');
  // playersEl.innerHTML = ['gracz','gracz2','gracz3','gracz5','gracz6','gracz7','gracz8'].map((n,i)=>`<div class="player ${i===5?'active':''}">${n}</div>`).join('');
</script>
</body>
</html>

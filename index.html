<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://www.gstatic.com https://www.gstatic.com/firebasejs/ 'unsafe-inline';
                 connect-src 'self' https://*.googleapis.com https://*.gstatic.com https://*.firebaseio.com https://*.firebaseinstallations.googleapis.com data: blob:;
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src 'self' data: https://fonts.gstatic.com;" />
  <title>Karty Dżentelmenów</title>
  <link href="https://fonts.googleapis.com/css2?family=Life+Savers:wght@400;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    html,body{margin:0;background:#f1f1f1;color:#0f0f0f;font-family:'Life Savers',cursive}
    .wrap{max-width:1400px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}

    header{
      display:flex;justify-content:center;align-items:center;
      margin-bottom:50px;
      background-image:url("assets/Ornament1.png");
      background-repeat:no-repeat;background-position:center 10px;background-size:100% 100px;
      padding-bottom:90px;position:relative;border:none;
    }
    .title{font-weight:900;font-size:32px;letter-spacing:.5px;margin-top:20px;}
    .hidden{display:none}
    .small{font-weight:700;font-size:16px}

    .players-bar{
      position:sticky;top:8px;z-index:10;
      display:flex;gap:18px;align-items:flex-end;justify-content:center;flex-wrap:wrap;
      padding:10px 0 22px;margin-bottom:30px;
    }
    .player{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:100px}
    .player-name{font-size:16px;font-weight:700;line-height:1}
    .player-slot{width:100px;height:22px;border:1px solid #0f0f0f;border-radius:1px;background:#f1f1f1}
    .player.active .player-slot{background:#0f0f0f}

    .row{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}

    .board{
      display:grid;grid-template-columns:1fr auto 1fr;
      column-gap:clamp(16px,4vw,40px);row-gap:24px;
      justify-items:center;align-items:;min-height:72vh;
    }
    .ctrl,.hand{width:280px;border:1px solid #0f0f0f;border-radius:1px;padding:14px;background:#f1f1f1}
    .ctrl{justify-self:end;position:sticky;top:56px;}
    .hand{justify-self:;}

    button{
      appearance:none;-webkit-appearance:none;
      border:1px solid #0f0f0f;border-radius:2px;background:#0f0f0f;color:#f1f1f1;
      font-weight:600;font-size:16px;padding:8px 14px;cursor:pointer;transition:background .15s ease,color .15s ease;
      font-family:'Life Savers';
    }
    button:hover{background:#222}
    button.ghost{background:#f1f1f1;color:#0f0f0f}
    button.ghost:hover{background:#e8e8e8}

    /* Środek — bez czarnego prostokąta */
    .prompt-wrap{grid-column:2;display:flex;align-items:center;justify-content:center;min-height:62vh;}
    .prompt{
      width:min(26vw,420px);
      aspect-ratio:2.5/3.5;
      /* usunięte tło/obramowanie */
      background:transparent;border:none;border-radius:0;
      display:flex;align-items:center;justify-content:center;text-align:center;
      padding:0;overflow:visible;transition:transform .22s ease,opacity .22s ease;
    }
    .prompt img{width:100%;height:100%;object-fit:contain;object-position: center;display:block}

    .hand-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1200px){ .hand-grid{grid-template-columns:repeat(3,1fr)} }
    .card-btn{border:1px solid #0f0f0f;border-radius:1px;background:#f1f1f1;cursor:pointer;padding:0;
      width:100%;aspect-ratio:2.5/3.5;display:flex;align-items:center;justify-content:center;overflow:hidden;transition:transform .15s ease}
    .card-btn:hover{transform:translateY(-2px)}
    .card-btn img{width:100%;height:100%;object-fit:cover;display:block}
    .card-btn .fallback{padding:10px;font-size:16px;text-align:center}

    .preview{position:fixed;inset:0;pointer-events:none;z-index:30;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.98);transition:opacity .18s ease,transform .18s ease}
    .preview.visible{opacity:1;transform:scale(1)}
    .preview-card{width:min(50vw,640px);aspect-ratio:2.5/3.5;border:1px solid #0f0f0f;border-radius:1px;background:#f1f1f1;
      box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden;display:flex;align-items:center;justify-content:center}
    .preview-card img{width:100%;height:100%;object-fit:cover;display:block}
    .preview-card .fallback{padding:16px;font-size:18px;text-align:center;color:#0f0f0f}

    body.previewing .prompt{transform:translateX(-6vw) scale(.9)}
    .card{border:1px solid #0f0f0f;border-radius:1px;padding:14px;background:#f1f1f1}
    .warn{border:1px solid #0f0f0f;border-radius:1px;padding:8px;background:#fff1f1;color:#0f0f0f}

    #screen-create .col,#screen-join .col{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;margin:0 auto;max-width:600px}
    #screen-create .row,#screen-join .row{margin-top:10px;}
    #screen-home{margin-top:-20px;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Karty Dżentelmenów</div>
    <div class="small" id="alert" class="warn hidden"></div>
  </header>

  <!--  -->
  <section id="screen-home" class="card">
    <div class="row">
      <button id="go-create">Stwórz lobby</button>
      <button id="go-join" class="ghost">Dołącz do gry</button>
    </div>
  </section>

  <!-- Tworzenie -->
  <section id="screen-create" class="card hidden">
    <div class="col" style="max-width:480px">
      <label class="small">Twój nick</label>
      <input id="create-nick" placeholder="np. Tymianek" />
      <div class="row">
        <button id="btn-create">Utwórz lobby</button>
        <button class="ghost" id="back1">Wróć</button>
      </div>
    </div>
  </section>

  <!-- Dołączanie -->
  <section id="screen-join" class="card hidden">
    <div class="col" style="max-width:480px">
      <label class="small">Kod pokoju</label>
      <input id="join-code" placeholder="np. R4F7" />
      <label class="small">Twój nick</label>
      <input id="join-nick" placeholder="np. Gość" />
      <div class="row">
        <button id="btn-join">Dołącz</button>
        <button class="ghost" id="back2">Wróć</button>
      </div>
    </div>
  </section>

  <!-- Rozgrywka -->
  <section id="screen-room" class="hidden">
    <div id="players" class="players-bar"></div>

    <div class="board">
      <aside class="ctrl">
        <button id="btn-ready" class="ghost hidden">Następna runda</button>
        <div class="col">
          <div class="small">Pokój</div>
          <div class="row">
            <div class="badge">Kod: <b id="room-code">—</b></div>
            <button id="copy-code" class="ghost">Kopiuj</button>
          </div>
          <div class="small" style="margin-top:8px">Sterowanie</div>
          <div class="row">
            <button id="btn-"> rundy</button>
            <button id="btn-leave" class="ghost">Wyjdź</button>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="badge">Runda: <b id="round-no">0</b></div>
            <div class="badge">Sędzia: <b id="czar-name">—</b></div>
          </div>
        </div>
      </aside>

      <main class="prompt-wrap">
        <div id="prompt" class="prompt"></div>
      </main>

      <aside class="hand">
        <div class="small" style="margin-bottom:8px">Twoja ręka</div>
        <div id="hand" class="hand-grid"></div>
      </aside>
    </div>

    <div id="answers" class="card hidden"></div>
  </section>
</div>

<div id="preview" class="preview hidden" aria-hidden="true">
  <div id="previewCard" class="preview-card"></div>
</div>

<script type="module">
  const $ = s => document.querySelector(s);
  const screens = { home: $('#screen-home'), create: $('#screen-create'), join: $('#screen-join'), room: $('#screen-room') };
  const playersEl = $('#players');
  const promptEl  = $('#prompt');
  const answersEl = $('#answers');
  const handEl    = $('#hand');
  const roundEl   = $('#round-no');
  const czarNameEl= $('#czar-name');
  const roomCodeEl= $('#room-code');
  const alertBox  = $('#alert');

  function show(name){ Object.values(screens).forEach(x=>x.classList.add('hidden')); screens[name].classList.remove('hidden'); }
  function warn(msg){ alertBox.textContent = msg; alertBox.classList.remove('hidden'); console.error(msg); }
  function nowarn(){ alertBox.classList.add('hidden'); alertBox.textContent=''; }

  $('#go-create').onclick = ()=> show('create');
  $('#go-join').onclick   = ()=> show('join');
  $('#back1').onclick     = ()=> show('home');
  $('#back2').onclick     = ()=> show('home');
  $('#btn-ready').onclick = () => readyForNextRound();

  let firebaseReady=false, me={id:null,name:null}, room=null;
  let unsubRoom=null, unsubPlayers=null, unsubSubs=null, unsubHand=null;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6emXNbCXSwx2xCAaUnQw9YR29Zzg1JzU",
    authDomain: "karty-dzentelmenow.firebaseapp.com",
    projectId: "karty-dzentelmenow",
    storageBucket: "karty-dzentelmenow.appspot.com",
    messagingSenderId: "1024966784216",
    appId: "1:1024966784216:web:9eecee00ee849f079313ad"
  };

  let app, auth, db;
  try{
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    await signInAnonymously(auth);
    db = getFirestore(app);
    firebaseReady = true; nowarn();
  }catch(e){
    console.error("AUTH ERROR:", e);
    warn('Firebase nie działa: ' + (e?.code || e?.message || e));
  }

  /* ====== CZARNE KARTY (PNG) – manifest lub numeracja ====== */
  const BLACK_CARD_FALLBACK_COUNT = 96; // używane tylko gdy brak manifestu
  let BLACK_DECK = [];

  async function loadBlackDeck(){
    try{
      const res = await fetch('assets/karty/czarne/manifest.json', {cache:'no-store'});
      if(res.ok){
        const arr = await res.json();
        BLACK_DECK = arr.map(name => `assets/karty/czarne/${name}`);
      }else{
        BLACK_DECK = Array.from({length: BLACK_CARD_FALLBACK_COUNT},
          (_,i)=>`assets/karty/czarne/${String(i+1).padStart(1,'0')}.png`);
      }
    }catch(_){
      BLACK_DECK = Array.from({length: BLACK_CARD_FALLBACK_COUNT},
        (_,i)=>`assets/karty/czarne/${String(i+1).padStart(1,'0')}.png`);
    }
  }
  await loadBlackDeck();

  function makeCode(len=4){ const a='ABCDEFGHJKMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
  function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  $('#btn-create').onclick= ()=> firebaseReady? createLobby(): warn('Backend niegotowy. Odśwież.');
  $('#btn-join').onclick  = ()=> firebaseReady? joinLobby()  : warn('Backend niegotowy.');
  $('#btn-start').onclick = ()=> firebaseReady? startRound() : warn('Backend niegotowy.');
  $('#btn-leave').onclick = ()=> firebaseReady? leaveRoom()  : show('home');
  $('#copy-code').onclick = ()=> copyCode();

  show('home');

async function createLobby(){
  try{
    const nick = $('#create-nick').value.trim() || 'Gracz';
    const code = makeCode();
    const uid  = auth.currentUser.uid; 
    me = {id: uid, name: nick};

    const roomRef = doc(db,'rooms',code);
    await setDoc(roomRef,{
      code, createdAt: serverTimestamp(), stage:'lobby', round:0,
      czarId:null, czarIdx:0, winner:null,
      // tylko czarne
      deckBlack: shuffle([...BLACK_DECK]),
      discardBlack: [],
      currentBlack: null,
      hostId: uid,            // <- PRZECINEK TU
      turnOrder: []           // można bez przecinka na końcu
    });

    await setDoc(doc(db,'rooms',code,'players',uid),{
      name:nick, score:0, joinedAt:serverTimestamp(), is:true
    });
    await setDoc(doc(db,'rooms',code,'hands',uid),{ cards:[] });

    await enterRoom(code);
  }catch(e){ warn('Błąd tworzenia pokoju: '+(e?.message||e)); }
}

  async function joinLobby(){
    try{
      const code = ($('#join-code').value||'').trim().toUpperCase();
      const nick = ($('#join-nick').value||'').trim() || 'Gość';
      if(!code) return warn('Podaj kod.');
      const roomRef = doc(db,'rooms',code);
      if(!(await getDoc(roomRef)).exists()) return warn('Nie ma takiego pokoju.');

      const uid = auth.currentUser.uid; me = {id: uid, name: nick};
      await setDoc(doc(db,'rooms',code,'players',uid),{ name:nick, score:0, joinedAt:serverTimestamp(), isOnline:true });
      const handRef = doc(db,'rooms',code,'hands',uid);
      if(!(await getDoc(handRef)).exists()) await setDoc(handRef,{cards:[]});
      await enterRoom(code);
    }catch(e){ warn('Błąd dołączania: '+(e?.message||e)); }
  }

  async function enterRoom(code){ subscribeRoom(code); show('room'); }

  function subscribeRoom(code){
    roomCodeEl.textContent = code;
    unsubRoom?.(); unsubPlayers?.(); unsubSubs?.(); unsubHand?.();

    const roomRef = doc(db,'rooms',code);
    unsubRoom = onSnapshot(roomRef,(snap)=>{ room = snap.data(); renderRoom(); });

    const playersCol = collection(db,'rooms',code,'players');
    unsubPlayers = onSnapshot(playersCol,(snap)=>{
      room.players = []; snap.forEach(d=>room.players.push({id:d.id,...d.data()}));
      renderPlayers();
    });

    const subsCol = collection(db,'rooms',code,'submissions');
    unsubSubs = onSnapshot(subsCol,(snap)=>{
      room.submissions = []; snap.forEach(d=>room.submissions.push({id:d.id,...d.data()}));
      renderSubmissions();
    });

    const handRef = doc(db,'rooms',code,'hands',(auth.currentUser||{}).uid||'');
    unsubHand = onSnapshot(handRef,(snap)=>{ room.myHand = snap.data()?.cards || []; renderHand(); });
  }

  async function leaveRoom(){
    try{
      if(!room) { show('home'); return; }
      const code = room.code; const uid = (auth.currentUser||{}).uid;
      await Promise.all([
        deleteDoc(doc(db,'rooms',code,'players',uid)),
        deleteDoc(doc(db,'rooms',code,'hands',uid)),
        deleteDoc(doc(db,'rooms',code,'submissions',uid)).catch(()=>{})
      ]);
      unsubRoom?.(); unsubPlayers?.(); unsubSubs?.(); unsubHand?.();
      room=null; show('home');
    }catch(e){ warn('Błąd opuszczania pokoju: '+(e?.message||e)); }
  }

async function startRound() {
  try {
    if (!room) return;
    if (((auth.currentUser || {}).uid) !== room.hostId)
      return warn("Tylko host może rozpocząć rundę.");
    const code = room.code;

    // pobieramy wszystkich graczy
    const playersSnap = await getDocs(collection(db, "rooms", code, "players"));
    const players = [];
    playersSnap.forEach((d) => players.push({ id: d.id, ...d.data() }));
    if (!players.length) return warn("Brak graczy.");

    // --- KOLEJNOŚĆ GRACZY ---
    let order = Array.isArray(room.turnOrder) ? [...room.turnOrder] : [];
    const byId = new Map(players.map((p) => [p.id, p]));

    // uzupełnij brakujących graczy
    let orderedPlayers = order.map((id) => byId.get(id)).filter(Boolean);
    const missing = players.filter((p) => !order.includes(p.id));
    if (missing.length) {
      missing.sort(
        (a, b) => (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0)
      );
      orderedPlayers = orderedPlayers.concat(missing);
      order = orderedPlayers.map((p) => p.id);
    }

    // --- WYBÓR SĘDZIEGO ---
    let idx;
    const firstRound = !room.round || room.round === 0 || !room.czarId;
    if (firstRound) {
      idx = Math.floor(Math.random() * orderedPlayers.length); // losowy pierwszy
    } else {
      idx = room.czarIdx || 0; // kolejny
    }
    const czar = orderedPlayers[idx];
    const nextIdx = (idx + 1) % orderedPlayers.length;

    // --- CZARNA KARTA ---
    let deckBlack = [...(room.deckBlack || [])];
    let discardBlack = [...(room.discardBlack || [])];
    if (room.currentBlack) discardBlack.push(room.currentBlack);

    if (!deckBlack.length) {
      deckBlack = shuffle(discardBlack);
      discardBlack = [];
    }
    if (!deckBlack.length) return warn("Brak czarnych kart.");
    const blackUrl = deckBlack.shift();

    // --- ZAPIS DO FIRESTORE ---
    const batch = writeBatch(db);

    // usuń stare zagrania
    const subsSnap = await getDocs(collection(db, "rooms", code, "submissions"));
    subsSnap.forEach((s) =>
      batch.delete(doc(db, "rooms", code, "submissions", s.id))
    );

    batch.update(doc(db, "rooms", code), {
      stage: "playing",
      round: (room.round || 0) + 1,
      czarId: czar.id,
      czarIdx: nextIdx,
      turnOrder: order,
      winner: null,
      currentBlack: blackUrl,
      deckBlack,
      discardBlack,
    });

    await batch.commit();
  } catch (e) {
    warn("Błąd startu rundy: " + (e?.message || e));
  }
}


  async function readyForNextRound() {
    if (!room) return;
    const code = room.code;
    const uid = auth.currentUser?.uid;

    await setDoc(doc(db, "rooms", code, "ready", uid), { uid, ready: true, at: serverTimestamp() });

    const readySnap = await getDocs(collection(db, "rooms", code, "ready"));
    const readyCount = readySnap.size;
    const totalPlayers = room.players?.length || 0;

    if (readyCount >= totalPlayers) {
      const batch = writeBatch(db);
      readySnap.forEach(d => batch.delete(doc(db, "rooms", code, "ready", d.id)));
      await batch.commit();
      startRound();
    }
  }

  // Poniższe zostają jako szkic pod białe karty (obrazki) – na razie nic nie rozdaje
  async function playCard(index){ warn('Białe karty będą jako PNG – wdrożymy w kolejnym kroku.'); }
  async function chooseWinner(uid){ /* zostawione jak było – wypełnimy przy białych */ }

  function copyCode(){ if(!room?.code) return; navigator.clipboard.writeText(room.code).catch(()=>{}); }

  /* RENDER */
  function renderRoom(){
    if(!room) return;
    roundEl.textContent = room.round||0;

    // pokaż czarną kartę PNG lub nic
    if(room.currentBlack){
      promptEl.innerHTML = `<img src="${room.currentBlack}" alt="Czarna karta">`;
    }else{
      promptEl.innerHTML = ``; // brak prostokąta
    }

    const czar = (room.players||[]).find(p=>p.id===room.czarId);
    czarNameEl.textContent = czar? czar.name : '—';

    const isHost = (auth.currentUser?.uid === room.hostId);
    $('#btn-start').classList.toggle('hidden', !isHost);
    $('#btn-ready').classList.toggle('hidden', isHost);
  }

function renderPlayers() {
  const players = room?.players || [];
  const order = room?.turnOrder || players.map((p) => p.id);
  const map = new Map(players.map((p) => [p.id, p]));
  const ordered = order.map((id) => map.get(id)).filter(Boolean);

  const czarId = room?.czarId || null;
  playersEl.innerHTML = ordered
    .map(
      (p) => `
      <div class="player ${p.id === czarId ? "active" : ""}">
        <div class="player-name">${esc(p.name)}</div>
        <div class="player-slot" aria-hidden="true"></div>
      </div>`
    )
    .join("");
}

  function renderSubmissions(){
    const subs = room?.submissions || [];
    if(!subs.length){ answersEl.classList.add('hidden'); answersEl.innerHTML=''; return; }
    answersEl.classList.remove('hidden');
    answersEl.innerHTML = `<div class="small" style="margin-bottom:8px">Zagrania</div>` +
      subs.map(s=>`<button class="card-btn" data-uid="${s.uid}"><div class="fallback">${esc(s.text||'—')}</div></button>`).join('');
  }

  function renderHand(){
    const hand = room?.myHand || [];
    handEl.innerHTML = hand.map((t,i)=>`
      <button class="card-btn" data-i="${i}">
        <div class="fallback">${esc(t)}</div>
      </button>`).join('');
  }

  Object.defineProperty(window,'firebaseAuthUid',{get(){return (auth&&auth.currentUser)?auth.currentUser.uid:null;}});

  // Dev: show('room');
</script>
</body>
</html>






